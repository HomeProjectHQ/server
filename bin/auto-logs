#!/bin/bash
# Simple Auto workflow monitor - shows Auto workflow events and job logs

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
LOG_FILE="$APP_DIR/log/development.log"

if [ ! -f "$LOG_FILE" ]; then
  echo "Log file not found: $LOG_FILE"
  exit 1
fi

echo "Auto Workflow Monitor - Press Ctrl+C to stop"
echo "Showing: Workflow events and job execution logs only"
echo

# Show only meaningful Auto workflow events:
# - [Auto::Node] ✓ - Node completions
# - [Scheduler] Cycle: - Work cycle summaries (when work happens)
# - [Scheduler] Transitioned - Node transitions
# - [Auto::Scheduler] ▶/■ - Workflow start/complete
# - [Auto::WhereJob], [Auto::LlmJob], etc. - Actual job logs
# - [Scheduler] Anti-entropy - Repair logs
# 
# Filter OUT:
# - Idle cycles (too noisy when no work)
# - ActiveJob lifecycle (Performing/Performed/Enqueued)
# - SQL queries and transactions
# - Re-enqueueing messages
tail -f "$LOG_FILE" | \
  grep --line-buffered -E '\[Auto::(Node|WhereJob|LlmJob|CreateJob|UpdateJob|FindByJob|FindOrCreateByJob|ConditionalJob|LoopJob|ForkJob|NoopJob|FileJob|FileSystemJob|FfmpegJob|MediaParserJob|TmdbJob)\]|\[Scheduler\] (Cycle: .*(started=[1-9]|jobs=[1-9]|transitioned=[1-9]|completed=[1-9]|failed=[1-9]|repaired=[1-9])|Transitioned|Anti-entropy)|\[Auto::Scheduler\] [▶■]'

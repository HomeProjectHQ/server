---
id: scan_media_folders
name: Scan Media Folders
description: Scan media folders for new episodes
nodes:
  - id: media_folder_loop
    name: Media Folder Loop
    start: true
    type: loop
    args:
      loop_source_rel: "${MediaFolder.enabled}"
      loop_iteration: "${media_folder_loop.iteration}"
    next:
      loop: ls_movies
      done: workflow_complete
      default:
    editor:
      x: -150.0
      "y": -150.0
  - id: ls_movies
    name: Find All Movie Files
    type: file_system
    args:
      operation: glob
      path: "${media_folder_loop.item.path}/Movies-Kate"
      pattern: "**/*.{mkv,mp4,avi,mov,m4v,wmv,flv,webm}"
    next:
      default: movies
    editor:
      x: -200.0
      "y": 125.0
  - id: movies
    name: Process Movies in Parallel
    type: parallel
    args:
      items: "${ls_movies}"
    next:
      default: parse_movie_filename
    editor:
      x: -250
      "y": 400
  - id: parse_movie_filename
    name: Parse Movie Filename
    type: media_parser
    args:
      operation: movie
      path: "${movies.item.path}"
    next:
      default: tmdb_movie_search
    editor:
      x: -250.0
      "y": 625.0
  - id: tmdb_movie_search
    name: TMDB Movie Search
    type: tmdb
    args:
      operation: search_movie
      title: "${parse_movie_filename.title}"
      year: "${parse_movie_filename.year}"
    next:
      success: tmdb_movie_found
      not_found: all_movies_imported
      default:
    editor:
      x: -250.0
      "y": 850.0
  - id: tmdb_movie_found
    name: TMDB Movie Found
    type: conditional
    args:
      condition: "${tmdb_movie_search.results}"
    next:
      true: find_movie
      false: all_movies_imported
      default:
    editor:
      x: -300.0
      "y": 1125.0
  - id: find_movie
    name: Find Movie
    type: find_by
    args:
      table: Movie
      key: tmdb_id
      value: "${tmdb_movie_search.results[0].id}"
    next:
      default: update_movie
      not_found: create_movie
    editor:
      x: -450.0
      "y": 1350.0
  - id: update_movie
    name: Update Movie
    type: update
    args:
      table: Movie
      id: "${find_movie.id}"
      values:
        title: "${tmdb_movie_search.results[0].title}"
        original_title: "${tmdb_movie_search.results[0].original_title}"
        year: "${tmdb_movie_search.results[0].release_date}"
        release_date: "${tmdb_movie_search.results[0].release_date}"
        overview: "${tmdb_movie_search.results[0].overview}"
        tagline: "${tmdb_movie_search.results[0].tagline}"
        poster_path: "${tmdb_movie_search.results[0].poster_path}"
        backdrop_path: "${tmdb_movie_search.results[0].backdrop_path}"
        runtime: "${tmdb_movie_search.results[0].runtime}"
        rating: "${tmdb_movie_search.results[0].vote_average}"
        vote_average: "${tmdb_movie_search.results[0].vote_average}"
        vote_count: "${tmdb_movie_search.results[0].vote_count}"
        popularity: "${tmdb_movie_search.results[0].popularity}"
        imdb_id: "${tmdb_movie_search.results[0].imdb_id}"
        original_language: "${tmdb_movie_search.results[0].original_language}"
        budget: "${tmdb_movie_search.results[0].budget}"
        revenue: "${tmdb_movie_search.results[0].revenue}"
        homepage: "${tmdb_movie_search.results[0].homepage}"
        file_path: "${movies.item.path}"
    next:
      default: all_movies_imported
    editor:
      x: -625.0
      "y": 1625.0
  - id: create_movie
    name: Create Movie
    type: create
    args:
      table: Movie
      values:
        title: "${tmdb_movie_search.results[0].title}"
        original_title: "${tmdb_movie_search.results[0].original_title}"
        tmdb_id: "${tmdb_movie_search.results[0].id}"
        year: "${tmdb_movie_search.results[0].release_date}"
        release_date: "${tmdb_movie_search.results[0].release_date}"
        overview: "${tmdb_movie_search.results[0].overview}"
        tagline: "${tmdb_movie_search.results[0].tagline}"
        poster_path: "${tmdb_movie_search.results[0].poster_path}"
        backdrop_path: "${tmdb_movie_search.results[0].backdrop_path}"
        runtime: "${tmdb_movie_search.results[0].runtime}"
        rating: "${tmdb_movie_search.results[0].vote_average}"
        vote_average: "${tmdb_movie_search.results[0].vote_average}"
        vote_count: "${tmdb_movie_search.results[0].vote_count}"
        popularity: "${tmdb_movie_search.results[0].popularity}"
        imdb_id: "${tmdb_movie_search.results[0].imdb_id}"
        original_language: "${tmdb_movie_search.results[0].original_language}"
        budget: "${tmdb_movie_search.results[0].budget}"
        revenue: "${tmdb_movie_search.results[0].revenue}"
        homepage: "${tmdb_movie_search.results[0].homepage}"
        file_path: "${movies.item.path}"
    next:
      default: all_movies_imported
    editor:
      x: -375.0
      "y": 1625.0
  - id: all_movies_imported
    name: All Movies Imported
    type: merge
    next:
      default: ls_tv_shows
    editor:
      x: -500.0
      "y": 2050.0
  - id: ls_tv_shows
    name: Find All TV Episode Files
    type: file_system
    args:
      operation: glob
      path: "${media_folder_loop.item.path}/TV-Kate"
      pattern: "**/*.{mkv,mp4,avi,mov,m4v,wmv,flv,webm}"
    next:
      default: tv_loop
    editor:
      x: -500.0
      "y": 2225.0
  - id: tv_loop
    name: Process TV Episodes in Parallel
    type: parallel
    args:
      items: "${ls_tv_shows}"
    next:
      default: parse_tv_filename
    editor:
      x: -500.0
      "y": 2450.0
  - id: parse_tv_filename
    name: Parse TV Filename
    type: media_parser
    args:
      operation: tv_episode
      path: "${tv_loop.item.path}"
    next:
      default: tmdb_tv_search
    editor:
      x: -500.0
      "y": 2650.0
  - id: tmdb_tv_search
    name: TMDB TV Show Search
    type: tmdb
    args:
      operation: search_tv
      title: "${parse_tv_filename.show}"
    next:
      success: tmdb_tv_found
      not_found: all_tv_shows_imported
      default:
    editor:
      x: -500.0
      "y": 2900.0
  - id: tmdb_tv_found
    name: TMDB TV Show Found
    type: conditional
    args:
      condition: "${tmdb_tv_search.results}"
    next:
      true: find_or_create_tv_show
      false: all_tv_shows_imported
      default:
    editor:
      x: -550.0
      "y": 3175.0
  - id: find_or_create_tv_show
    name: Find or Create TV Show
    type: find_or_create_by
    args:
      table: TvShow
      find_by:
        tmdb_id: "${tmdb_tv_search.results[0].id}"
      attributes:
        title: "${tmdb_tv_search.results[0].name}"
        original_name: "${tmdb_tv_search.results[0].original_name}"
        year: "${tmdb_tv_search.results[0].first_air_date}"
        first_air_date: "${tmdb_tv_search.results[0].first_air_date}"
        last_air_date: "${tmdb_tv_search.results[0].last_air_date}"
        overview: "${tmdb_tv_search.results[0].overview}"
        tagline: "${tmdb_tv_search.results[0].tagline}"
        poster_path: "${tmdb_tv_search.results[0].poster_path}"
        backdrop_path: "${tmdb_tv_search.results[0].backdrop_path}"
        status: "${tmdb_tv_search.results[0].status}"
        vote_average: "${tmdb_tv_search.results[0].vote_average}"
        vote_count: "${tmdb_tv_search.results[0].vote_count}"
        popularity: "${tmdb_tv_search.results[0].popularity}"
        original_language: "${tmdb_tv_search.results[0].original_language}"
        homepage: "${tmdb_tv_search.results[0].homepage}"
        number_of_episodes: "${tmdb_tv_search.results[0].number_of_episodes}"
        number_of_seasons: "${tmdb_tv_search.results[0].number_of_seasons}"
        in_production: "${tmdb_tv_search.results[0].in_production}"
        show_type: "${tmdb_tv_search.results[0].type}"
    next:
      default: find_or_create_tv_season
    editor:
      x: -575.0
      "y": 3425.0
  - id: find_or_create_tv_season
    name: Find or Create Season
    type: find_or_create_by
    args:
      table: TvSeason
      find_by:
        tv_show_id: "${find_or_create_tv_show.id}"
        season_number: "${parse_tv_filename.season}"
    next:
      default: find_episode_by_number
    editor:
      x: -575.0
      "y": 3825.0
  - id: find_episode_by_number
    name: Find Episode by Number
    type: find_by
    args:
      table: TvEpisode
      key: tv_season_id
      value: "${find_or_create_tv_season.id}"
      where:
        episode_number: "${parse_tv_filename.episode}"
    next:
      default: update_episode_path
      not_found: fetch_episode_metadata
    editor:
      x: -575.0
      "y": 3875.0
  - id: update_episode_path
    name: Update Episode Path
    type: update
    args:
      table: TvEpisode
      id: "${find_episode_by_number.id}"
      values:
        file_path: "${tv_loop.item.path}"
    next:
      default: all_tv_shows_imported
    editor:
      x: -775.0
      "y": 4100.0
  - id: fetch_episode_metadata
    name: Fetch Episode Metadata from TMDB
    type: tmdb
    args:
      operation: episode_detail
      tmdb_id: "${tmdb_tv_search.results[0].id}"
      season_number: "${parse_tv_filename.season}"
      episode_number: "${parse_tv_filename.episode}"
    next:
      default: create_episode
    editor:
      x: -375.0
      "y": 4100.0
  - id: create_episode
    name: Create Episode
    type: create
    args:
      table: TvEpisode
      values:
        tv_season_id: "${find_or_create_tv_season.id}"
        episode_number: "${parse_tv_filename.episode}"
        title: "${fetch_episode_metadata.name}"
        overview: "${fetch_episode_metadata.overview}"
        air_date: "${fetch_episode_metadata.air_date}"
        runtime: "${fetch_episode_metadata.runtime}"
        still_path: "${fetch_episode_metadata.still_path}"
        file_path: "${tv_loop.item.path}"
    next:
      default: all_tv_shows_imported
    editor:
      x: -400.0
      "y": 4325.0
  - id: all_tv_shows_imported
    name: All TV Shows Imported
    type: merge
    next:
      default: media_folder_loop
    editor:
      x: -600.0
      "y": 4700.0
  - id: workflow_complete
    name: Workflow Complete
    end: true
    type: noop
    next:
      default:
    editor:
      x: 200.0
      "y": 125.0

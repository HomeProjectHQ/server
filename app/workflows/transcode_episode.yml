---
id: transcode_episode
name: Transcode Episode to HLS
subject_type: TvEpisode
description: Transcode an episode to HLS format with multiple quality variants
nodes:
  - id: existence_check
    name: Check if HLS Master playlist Exists
    start: true
    type: file_system
    args:
      operation: exists
      path: "${subject.file_path}"
    next:
      default: already_exists
    editor:
      x: 0
      "y": 800
  - id: already_exists
    name: Check if HLS Already Exists
    type: conditional
    args:
      condition: "${existence_check.exists}"
    next:
      "true": workflow_complete
      "false": set_processing
    editor:
      x: 0
      "y": 800
  - id: set_processing
    name: Set Episode Processing Status
    type: update
    args:
      table: TvEpisode
      id: "${subject.id}"
      values:
        status: processing
    next:
      default: transcode_audio_stereo
    editor:
      x: 150.0
      "y": 1000.0
  - id: transcode_audio_stereo
    name: Transcode Stereo Audio Track (Required)
    type: ffmpeg
    args:
      input_file: "${subject.import_file_path}"
      output_dir: "${Setting.root_path}/TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}/audio_stereo"
      flags:
        map: "0:a"
        vn: true
        c:a: aac
        b:a: 192k
        ac: 2
        ar: 48000
        f: hls
        hls_time: 6
        hls_playlist_type: vod
        hls_list_size: 0
        hls_segment_type: fmp4
        hls_flags: independent_segments
        hls_fmp4_init_filename: init.mp4
        hls_segment_filename: segment_%03d.m4s
    next:
      default: transcode_audio_surround
    editor:
      x: 150.0
      "y": 1200.0
  - id: transcode_audio_surround
    name: Transcode 5.1 Surround Audio Track
    type: ffmpeg
    args:
      input_file: "${subject.import_file_path}"
      output_dir: "${Setting.root_path}/TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}/audio_surround"
      flags:
        map: "0:a"
        vn: true
        c:a: aac
        b:a: 320k
        ar: 48000
        f: hls
        hls_time: 6
        hls_playlist_type: vod
        hls_list_size: 0
        hls_segment_type: fmp4
        hls_flags: independent_segments
        hls_fmp4_init_filename: init.mp4
        hls_segment_filename: segment_%03d.m4s
    next:
      default: extract_subtitles_eng
    editor:
      x: 150.0
      "y": 1375.0
  - id: extract_subtitles_eng
    name: Extract English Subtitles
    type: ffmpeg
    args:
      input_file: "${subject.import_file_path}"
      output_dir: "${Setting.root_path}/TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}/subtitles_en"
      output_filename: segment_%03d.vtt
      flags:
        map: "0:s:0?"
        c:s: webvtt
        f: segment
        segment_time: 6
        segment_format: webvtt
        segment_list: index.m3u8
        segment_list_type: hls
    next:
      default: transcode_video_1080p
    editor:
      x: 150.0
      "y": 1462.5
  - id: transcode_video_1080p
    name: Transcode 1080p Video Only
    type: ffmpeg
    args:
      input_file: "${subject.import_file_path}"
      output_dir: "${Setting.root_path}/TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}/video_1080p"
      flags:
        map: "0:v"
        an: true
        c:v: hevc_videotoolbox
        tag:v: hvc1
        b:v: 12M
        pix_fmt: yuv420p
        vf: "scale=1920:1080:force_original_aspect_ratio=decrease,format=yuv420p,setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709"
        force_key_frames: "expr:gte(t,n_forced*6)"
        f: hls
        hls_time: 6
        hls_playlist_type: vod
        hls_list_size: 0
        hls_segment_type: fmp4
        hls_flags: independent_segments
        hls_fmp4_init_filename: init.mp4
        hls_segment_filename: segment_%03d.m4s
    next:
      default: transcode_video_720p
    editor:
      x: 150.0
      "y": 1550.0
  - id: transcode_video_720p
    name: Transcode 720p Video Only
    type: ffmpeg
    args:
      input_file: "${subject.import_file_path}"
      output_dir: "${Setting.root_path}/TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}/video_720p"
      flags:
        map: "0:v"
        an: true
        c:v: hevc_videotoolbox
        tag:v: hvc1
        b:v: 5M
        pix_fmt: yuv420p
        vf: "scale=1280:720:force_original_aspect_ratio=decrease,format=yuv420p,setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709"
        force_key_frames: "expr:gte(t,n_forced*6)"
        f: hls
        hls_time: 6
        hls_playlist_type: vod
        hls_list_size: 0
        hls_segment_type: fmp4
        hls_flags: independent_segments
        hls_fmp4_init_filename: init.mp4
        hls_segment_filename: segment_%03d.m4s
    next:
      default: create_master_playlist
    editor:
      x: 150.0
      "y": 1725.0
  - id: create_master_playlist
    name: Create Master Playlist
    type: file
    args:
      operation: write
      overwrite: true
      path: "${Setting.root_path}/TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}/index.m3u8"
      name: master_playlist
      contents: |
        #EXTM3U
        #EXT-X-VERSION:6

        # Subtitle renditions
        #EXT-X-MEDIA:TYPE=SUBTITLES,GROUP-ID="subs",NAME="English",DEFAULT=NO,AUTOSELECT=NO,LANGUAGE="en",URI="subtitles_en/index.m3u8"

        # Audio renditions (REQUIRED by Apple spec - Rule 2.3)
        #EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio",NAME="Stereo",DEFAULT=YES,AUTOSELECT=YES,LANGUAGE="en",URI="audio_stereo/index.m3u8"
        #EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio",NAME="Surround 5.1",DEFAULT=NO,AUTOSELECT=YES,LANGUAGE="en",CHANNELS="6",URI="audio_surround/index.m3u8"

        # 1080p variants with audio and subtitle selection
        #EXT-X-STREAM-INF:BANDWIDTH=12192000,RESOLUTION=1920x1080,AUDIO="audio",SUBTITLES="subs"
        video_1080p/index.m3u8
        #EXT-X-STREAM-INF:BANDWIDTH=12320000,RESOLUTION=1920x1080,AUDIO="audio",SUBTITLES="subs"
        video_1080p/index.m3u8

        # 720p variants with audio and subtitle selection
        #EXT-X-STREAM-INF:BANDWIDTH=5192000,RESOLUTION=1280x720,AUDIO="audio",SUBTITLES="subs"
        video_720p/index.m3u8
        #EXT-X-STREAM-INF:BANDWIDTH=5320000,RESOLUTION=1280x720,AUDIO="audio",SUBTITLES="subs"
        video_720p/index.m3u8
    next:
      default: mark_ready
    editor:
      x: 150.0
      "y": 1900.0
  - id: mark_ready
    name: Mark Episode as Ready
    type: update
    args:
      table: TvEpisode
      id: "${subject.id}"
      values:
        status: ready
        file_path: TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}
        stream_qualities: 1080p,720p,stereo,surround
    next:
      default: workflow_complete
    editor:
      x: 150.0
      "y": 2100.0
  - id: workflow_complete
    name: Workflow Complete
    end: true
    type: noop
    editor:
      x: 0
      "y": 2600

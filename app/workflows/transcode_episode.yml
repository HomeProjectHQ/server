id: transcode_episode
name: Transcode Episode to HLS
subject_type: TvEpisode
description: Transcode an episode to HLS format with multiple quality variants

nodes:
  - id: check_transcode_exists
    name: Check if HLS Master playlist Exists
    start: true
    type: file_system_job
    args:
      exists: "${subject.file_path.present?}"
      path: "${subject.file_path}"
    next:
      "true": workflow_complete
      "false": set_processing
    editor:
      x: 0
      "y": 800

  - id: check_hls_exists
    name: Check if HLS Already Exists
    start: true
    type: conditional
    args:
      condition: "${subject.file_path.present?}"
    next:
      "true": workflow_complete
      "false": set_processing
    editor:
      x: 0
      "y": 800

  - id: set_processing
    name: Set Episode Processing Status
    type: update
    args:
      table: TvEpisode
      id: "${subject.id}"
      values:
        status: processing
    next:
      default: transcode_1080p
    editor:
      x: -200
      "y": 1000

  - id: transcode_1080p
    name: Transcode 1080p Variant
    type: ffmpeg
    args:
      input_file: "${subject.import_file_path}"
      output_dir: >-
        ${Setting.root_path}/TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}/1080p
      variant_name: 1080p
      width: 1920
      height: 1080
      video_bitrate: 12M
      audio_bitrate: 256k
      bandwidth: 12000000
      codec_video: hevc_videotoolbox
      codec_audio: aac
      video_tag: hvc1
      pixel_format: yuv420p
      video_filter: >-
        scale=1920:1080:force_original_aspect_ratio=decrease,format=yuv420p,setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709
      force_key_frames: "expr:gte(t,n_forced*6)"
      audio_sample_rate: 48000
      hls_time: 6
      hls_playlist_type: vod
      hls_list_size: 0
      hls_segment_type: fmp4
      hls_flags: independent_segments
      hls_fmp4_init_filename: init.mp4
    next:
      default: transcode_720p
    editor:
      x: -200
      "y": 1200

  - id: transcode_720p
    name: Transcode 720p Variant
    type: ffmpeg
    args:
      input_file: "${subject.import_file_path}"
      output_dir: >-
        ${Setting.root_path}/TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}/720p
      variant_name: 720p
      width: 1280
      height: 720
      video_bitrate: 5M
      audio_bitrate: 128k
      bandwidth: 5000000
      codec_video: hevc_videotoolbox
      codec_audio: aac
      video_tag: hvc1
      pixel_format: yuv420p
      video_filter: >-
        scale=1280:720:force_original_aspect_ratio=decrease,format=yuv420p,setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709
      force_key_frames: "expr:gte(t,n_forced*6)"
      audio_sample_rate: 48000
      audio_channels: 2
      hls_time: 6
      hls_playlist_type: vod
      hls_list_size: 0
      hls_segment_type: fmp4
      hls_flags: independent_segments
      hls_fmp4_init_filename: init.mp4
    next:
      default: create_master_playlist
    editor:
      x: -200
      "y": 1400

  - id: create_master_playlist
    name: Create Master Playlist
    type: file
    args:
      operation: write
      overwrite: true
      path: "${Setting.root_path}/TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}/index.m3u8"
      name: master_playlist
      contents: >
        #EXTM3U
        #EXT-X-VERSION:6
        #EXT-X-STREAM-INF:BANDWIDTH=12000000,RESOLUTION=1920x1080,CODECS="hvc1.1.c.L120.90,mp4a.40.2"
        1080p/index.m3u8
        #EXT-X-STREAM-INF:BANDWIDTH=5000000,RESOLUTION=1280x720,CODECS="hvc1.1.c.L93.90,mp4a.40.2"
        720p/index.m3u8
    next:
      default: mark_ready
    editor:
      x: -200
      "y": 1600

  - id: mark_ready
    name: Mark Episode as Ready
    type: update
    args:
      table: TvEpisode
      id: "${subject.id}"
      values:
        status: ready
        file_path: >-
          TV Shows/${subject.tv_season.tv_show.title}/s${subject.tv_season.season_number}e${subject.episode_number}
        stream_qualities: "1080p,720p"
    next:
      default: workflow_complete
    editor:
      x: -250
      "y": 2000

  - id: workflow_complete
    name: Workflow Complete
    end: true
    type: noop
    editor:
      x: 0
      "y": 2600
